{% extends "blogs/base.html" %}

{% block title %}
  {{ ficha_tecnica.nome }} | Blog do Projeto | Luiz R. Dererita
{% endblock %}

{% block styles %}
  <link rel="stylesheet" href="{{ url_for('static', filename='css/blogs/style.css') }}">
  <style>
    .preview-separator {
      border-top: 1px solid #333;
      margin: 0.75rem 0 1rem;
    }
    #share-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.65);
      backdrop-filter: blur(2px);
      z-index: 998;
      opacity: 0;
      transition: opacity 0.3s ease;
    }

    #share-popup {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%) scale(0.95);
      background: #1c1c1c;
      color: white;
      padding: 1.5rem 2rem;
      border-radius: 12px;
      box-shadow: 0 8px 16px rgba(0,0,0,0.4);
      z-index: 999;
      width: 300px;
      max-width: 90%;
      opacity: 0;
      transition: opacity 0.3s ease, transform 0.3s ease;
    }

    #share-popup.active {
      opacity: 1;
      transform: translate(-50%, -50%) scale(1);
    }

    #share-overlay.active {
      opacity: 1;
    }

    .share-buttons {
      display: flex;
      gap: 15px;
      justify-content: center;
      margin-top: 1rem;
    }

    .share-buttons a,
    .share-buttons button {
      background: none;
      border: none;
      color: white;
      font-size: 1.5rem;
      cursor: pointer;
    }

    .btn-close-popup {
      position: absolute;
      top: 10px;
      right: 12px;
      background: none;
      border: none;
      font-size: 1.25rem;
      color: white;
      cursor: pointer;
    }

    .d-none {
      display: none !important;
    }
  </style>
{% endblock %}

{% block content %}
<!-- Seção de Postagens -->
<h2 class="section-title mt-4" id="postagens">Novidades</h2>

{% for post in posts %}
  <div class="card bg-dark text-white mb-4">
    <div class="card-body position-relative">

      <!-- Ícone de Compartilhamento -->
      <a href="#" 
        class="share-icon-top" 
        title="Compartilhar este post" 
        data-url="{{ url_for('ver_post', projeto=projeto, nome=post.nome_arquivo, _external=True) }}">
        <i class="fas fa-share-nodes"></i>
      </a>

      <h5 class="card-title">{{ post.titulo }}</h5>
      <p class="meta-info post-data">
        Postado em <strong>{{ post.data|data_extensa }}</strong> por <strong>{{ post.autor }}</strong>
      </p>

      <div class="preview-separator"></div>

      {% if post.imagem %}
        <img src="{{ url_for('static', filename=post.imagem) }}"
             alt="Preview de {{ post.titulo }}"
             class="preview-img-fluid">
      {% endif %}

      <p class="card-text mt-3">
        {{ post.conteudo|striptags|truncate(500, True, '...') }}
      </p>

      <a href="{{ url_for('ver_post', projeto=projeto, nome=post.nome_arquivo) }}"
         class="btn btn-outline-light btn-sm">
        Ler mais
      </a>

    <div class="preview-separator"></div>

    <div class="post-meta d-flex justify-content-start align-items-center gap-4 mt-2">
      <!-- Visualizações -->
      <span><i class="far fa-eye"></i> {{ post.visualizacoes or 0 }}</span>
      <!-- Comentários -->
      <span><i class="far fa-comment"></i> <span id="contador-{{ post.nome_arquivo }}">0</span></span>
      <!-- Disqus contador invisível para pegar os dados -->
      <a href="{{ url_for('ver_post', projeto=projeto, nome=post.nome_arquivo) }}#disqus_thread"
        class="disqus-comment-count d-none"
        data-disqus-identifier="{{ projeto }}/{{ post.nome_arquivo }}">
        0
      </a>
    </div>

    </div>
  </div>
{% endfor %}

<!-- Paginação -->
{% if total_paginas > 1 %}
  <nav>
    <ul class="pagination justify-content-center">
      <!-- Página Anterior -->
      <li class="page-item {% if pagina_atual == 1 %}disabled{% endif %}">
        <a class="page-link custom-page-link"
           href="{{ url_for('blog_index', projeto=projeto, pagina=pagina_atual - 1) }}">
          Anterior
        </a>
      </li>

      <!-- Números de Página -->
      {% for pagina in range(1, total_paginas + 1) %}
        <li class="page-item {% if pagina == pagina_atual %}active{% endif %}">
          <a class="page-link custom-page-link"
             href="{{ url_for('blog_index', projeto=projeto, pagina=pagina) }}">
            {{ pagina }}
          </a>
        </li>
      {% endfor %}

      <!-- Página Seguinte -->
      <li class="page-item {% if pagina_atual == total_paginas %}disabled{% endif %}">
        <a class="page-link custom-page-link"
           href="{{ url_for('blog_index', projeto=projeto, pagina=pagina_atual + 1) }}">
          Próxima
        </a>
      </li>
    </ul>
  </nav>
{% endif %}

<div class="post-separator"></div>

<!-- Popup de Compartilhamento -->
<div id="share-overlay" class="d-none"></div>
<div id="share-popup" class="d-none">
  <button class="btn-close-popup" title="Fechar">&times;</button>
  <p class="mb-2">Compartilhar este post:</p>
  <div class="share-buttons">
    <a id="share-whatsapp" target="_blank" title="WhatsApp"><i class="fab fa-whatsapp"></i></a>
    <a id="share-facebook" target="_blank" title="Facebook"><i class="fab fa-facebook"></i></a>
    <a id="share-twitter" target="_blank" title="Twitter"><i class="fab fa-x-twitter"></i></a>
    <button id="share-copy" title="Copiar link"><i class="fas fa-link"></i></button>
  </div>
</div>

{% endblock %}

{% block scripts %}
<script>
  document.addEventListener('DOMContentLoaded', function () {
    const popup = document.getElementById('share-popup');
    const overlay = document.getElementById('share-overlay');
    const btnClose = popup.querySelector('.btn-close-popup');
    const btnCopy = document.getElementById('share-copy');
    const btnWhatsapp = document.getElementById('share-whatsapp');
    const btnFacebook = document.getElementById('share-facebook');
    const btnTwitter = document.getElementById('share-twitter');

    document.querySelectorAll('.share-icon-top').forEach(btn => {
      btn.addEventListener('click', function (e) {
        e.preventDefault();
        const url = this.getAttribute('data-url');

        if (!url) return;

        btnWhatsapp.href = `https://wa.me/?text=${encodeURIComponent(url)}`;
        btnFacebook.href = `https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(url)}`;
        btnTwitter.href = `https://twitter.com/intent/tweet?url=${encodeURIComponent(url)}`;

        popup.classList.add('active');
        overlay.classList.add('active');
        popup.classList.remove('d-none');
        overlay.classList.remove('d-none');
      });
    });

    btnClose.addEventListener('click', () => {
      popup.classList.remove('active');
      overlay.classList.remove('active');
      popup.classList.add('d-none');
      overlay.classList.add('d-none');
    });

    overlay.addEventListener('click', () => {
      btnClose.click();
    });

    btnCopy.addEventListener('click', () => {
      const url = btnWhatsapp.href.split('=')[1];
      navigator.clipboard.writeText(decodeURIComponent(url));
      btnCopy.innerHTML = '<i class="fas fa-check"></i>';
      setTimeout(() => {
        btnCopy.innerHTML = '<i class="fas fa-link"></i>';
      }, 2000);
    });
  });
</script>
{% endblock %}
